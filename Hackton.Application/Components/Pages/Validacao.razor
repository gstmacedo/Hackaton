@page "/validacao/{Id:guid}"
@rendermode InteractiveServer
@using System.Text.Json
@inject HttpClient Http
@inject Microsoft.JSInterop.IJSRuntime JS

@using Microsoft.AspNetCore.Components

<div class="container mt-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb bg-white p-2 rounded shadow-sm">
            <li class="breadcrumb-item"><a href="/">Início</a></li>
            <li class="breadcrumb-item"><a href="/">Cadastros</a></li>
            <li class="breadcrumb-item active" aria-current="page">Validação</li>
        </ol>
    </nav>

    <div class="d-flex align-items-center mb-3">
        <div class="avatar bg-secondary rounded-circle d-flex align-items-center justify-content-center me-3" style="width:56px;height:56px;">
            <span class="text-white">@((aluno?.Aluno?.Nome?.Length ?? 0) > 0 ? aluno.Aluno.Nome[0].ToString().ToUpper() : "A")</span>
        </div>
        <div>
            <h4 class="mb-0">@aluno?.Aluno?.Nome</h4>
            <div class="small text-muted">Pré-cadastro: @aluno?.Aluno?.PreCadastroId</div>
        </div>
        <div class="ms-auto">
            <span class="badge @GetStatusClass(aluno?.Aluno?.Status)">@aluno?.Aluno?.Status</span>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="alert alert-info">Carregando informações do aluno...</div>
    }
    else if (loadError is not null)
    {
        <div class="alert alert-danger">Erro: @loadError</div>
    }
    else if (aluno is null)
    {
        <div class="alert alert-warning">Nenhum aluno encontrado.</div>
    }
    else
    {
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Dados do Aluno</h5>

                <div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">Informações Pessoais</div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <label class="form-label small text-muted">ID</label>
                                        <input class="form-control-plaintext" readonly value="@aluno?.Aluno?.Id" />
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small text-muted">Nome completo</label>
                                        <input class="form-control-plaintext" readonly value="@aluno?.Aluno?.Nome" />
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small text-muted">Nome da mãe</label>
                                        <input class="form-control-plaintext" readonly value="@aluno?.Aluno?.NomeName" />
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small text-muted">Nome do pai</label>
                                        <input class="form-control-plaintext" readonly value="@aluno?.Aluno?.NomePai" />
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small text-muted">RG (Aluno)</label>
                                        <input class="form-control-plaintext" readonly value="@aluno?.Aluno?.RgAluno" />
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small text-muted">RG (Responsável)</label>
                                        <input class="form-control-plaintext" readonly value="@aluno?.Aluno?.RgResponsavel" />
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small text-muted">Status</label>
                                        <input class="form-control-plaintext" readonly value="@aluno?.Aluno?.Status" />
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header">Endereço</div>
                                <div class="card-body">
                                    @if (aluno?.Endereco == null)
                                    {
                                        <div class="text-muted">Nenhum endereço cadastrado.</div>
                                    }
                                    else
                                    {
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Logradouro</label>
                                            <input class="form-control-plaintext" readonly value="@aluno.Endereco.Logradouro" />
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Número</label>
                                            <input class="form-control-plaintext" readonly value="@aluno.Endereco.Numero" />
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Complemento</label>
                                            <input class="form-control-plaintext" readonly value="@aluno.Endereco.Complemento" />
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Bairro</label>
                                            <input class="form-control-plaintext" readonly value="@aluno.Endereco.Bairro" />
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Cidade</label>
                                            <input class="form-control-plaintext" readonly value="@aluno.Endereco.Cidade" />
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Estado</label>
                                            <input class="form-control-plaintext" readonly value="@aluno.Endereco.Estado" />
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">CEP</label>
                                            <input class="form-control-plaintext" readonly value="@aluno.Endereco.Cep" />
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">Documentos / Anexos</div>
                                <div class="card-body">
                                    @if (aluno?.DocumentoAluno == null)
                                    {
                                        <div class="text-muted">Nenhum documento enviado.</div>
                                    }
                                    else
                                    {
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Tipo</label>
                                            <input class="form-control-plaintext" readonly value="@aluno.DocumentoAluno.TipoDocumento" />
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Arquivo</label>
                                            @if (!string.IsNullOrEmpty(aluno.DocumentoAluno.CaminhoArquivo) && Uri.IsWellFormedUriString(aluno.DocumentoAluno.CaminhoArquivo, UriKind.Absolute))
                                            {
                                                <a class="btn btn-sm btn-outline-primary" target="_blank" href="@aluno.DocumentoAluno.CaminhoArquivo">Abrir arquivo</a>
                                            }
                                            else
                                            {
                                                <input class="form-control-plaintext" readonly value="@aluno.DocumentoAluno.CaminhoArquivo" />
                                            }
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Tipo MIME</label>
                                            <input class="form-control-plaintext" readonly value="@aluno.DocumentoAluno.TipoMime" />
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small text-muted">Enviado em</label>
                                            <input class="form-control-plaintext" readonly value="@FormatValueString(aluno.DocumentoAluno.EnviadoEm)" />
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header">Metadados</div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12 col-md-6 mb-2">
                                            <label class="form-label small text-muted">PreCadastroId</label>
                                            <input class="form-control-plaintext" readonly value="@aluno?.Aluno?.PreCadastroId" />
                                        </div>
                                        <div class="col-6 col-md-3 mb-2">
                                            <label class="form-label small text-muted">Criado em</label>
                                            <input class="form-control-plaintext" readonly value="@FormatValueString(aluno?.Aluno?.CriadoEm)" />
                                        </div>
                                        <div class="col-6 col-md-3 mb-2">
                                            <label class="form-label small text-muted">Atualizado em</label>
                                            <input class="form-control-plaintext" readonly value="@FormatValueString(aluno?.Aluno?.AtualizadoEm)" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Observações do validador</label>
                        <textarea class="form-control" @bind="validatorNotes" rows="4" placeholder="Adicione comentários, razões para rejeição, etc..."></textarea>
                    </div>
                </div>

                <div class="mt-3 d-flex justify-content-end gap-2">
                    <button class="btn btn-danger" @onclick="Reject" disabled="@isProcessing">Rejeitar</button>
                    <button class="btn btn-success" @onclick="Approve" disabled="@isProcessing">Aprovar</button>
                </div>

                @if (!string.IsNullOrEmpty(statusMessage))
                {
                    <div class="mt-3 alert alert-secondary">@statusMessage</div>
                }
            </div>
        </div>
    }
</div>

@code {
    private AlunoCompleto? aluno;
    private bool isLoading = true;
    private bool isProcessing = false;
    private string? loadError;
    private string? statusMessage;
    private string? validatorNotes;

    [Parameter]
    public Guid? Id { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        try
        {

            aluno = await Http.GetFromJsonAsync<AlunoCompleto>($"https://localhost:7297/Aluno/GetAlunoById?id={Id}");
            if (aluno is not null)
            {
                // loaded
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private string FormatValueString(object? value)
    {
        if (value == null) return "(vazio)";
        if (value is DateTime dt) return dt.ToString("g");
        return value.ToString() ?? string.Empty;
    }

    private Dictionary<string, List<System.Reflection.PropertyInfo>> GroupProperties(object entity)
    {
        var result = new Dictionary<string, List<System.Reflection.PropertyInfo>>(StringComparer.OrdinalIgnoreCase)
        {
            ["personal"] = new List<System.Reflection.PropertyInfo>(),
            ["address"] = new List<System.Reflection.PropertyInfo>(),
            ["attachments"] = new List<System.Reflection.PropertyInfo>(),
            ["others"] = new List<System.Reflection.PropertyInfo>()
        };

        var props = entity.GetType().GetProperties();
        foreach (var p in props)
        {
            var name = p.Name.ToLowerInvariant();
            if (new[] { "nome", "name", "cpf", "rg", "email", "telefone", "celular", "birth", "nascimento", "data", "sexo" }.Any(k => name.Contains(k)))
            {
                result["personal"].Add(p);
            }
            else if (new[] { "endereco", "endereço", "rua", "bairro", "cidade", "estado", "cep", "complemento" }.Any(k => name.Contains(k)))
            {
                result["address"].Add(p);
            }
            else if (new[] { "anexo", "attachment", "documento", "foto", "file", "files", "imagem", "image" }.Any(k => name.Contains(k)))
            {
                result["attachments"].Add(p);
            }
            else
            {
                result["others"].Add(p);
            }
        }

        return result;
    }

    private MarkupString RenderAttachmentValue(object? value)
    {
        if (value == null) return (MarkupString)"<div class=\"text-muted\">(nenhum)</div>";

        if (value is string s)
        {
            if (Uri.IsWellFormedUriString(s, UriKind.Absolute))
                return (MarkupString)$"<a href=\"{s}\" target=\"_blank\">Abrir anexo</a>";
            return (MarkupString)System.Net.WebUtility.HtmlEncode(s);
        }

        if (value is IEnumerable<string> seq)
        {
            var sb = new System.Text.StringBuilder();
            sb.Append("<ul class=\"list-unstyled\">");
            foreach (var item in seq)
            {
                if (Uri.IsWellFormedUriString(item, UriKind.Absolute))
                    sb.Append($"<li><a href=\"{item}\" target=\"_blank\">{System.Net.WebUtility.HtmlEncode(item)}</a></li>");
                else
                    sb.Append($"<li>{System.Net.WebUtility.HtmlEncode(item)}</li>");
            }
            sb.Append("</ul>");
            return (MarkupString)sb.ToString();
        }

        // fallback
        return (MarkupString)System.Net.WebUtility.HtmlEncode(value.ToString() ?? string.Empty);
    }

    private Guid? GetEntityId()
    {
        if (Id != null) return Id;
        if (aluno == null) return null;
        var type = aluno.GetType();
        var idProp = type.GetProperty("Id") ?? type.GetProperty("ID") ?? type.GetProperty("AlunoId")
                     ?? type.GetProperties().FirstOrDefault(p => p.Name.EndsWith("Id", StringComparison.OrdinalIgnoreCase));
        if (idProp == null) return null;
        var val = idProp.GetValue(aluno);
        if (val == null) return null;
        if (val is Guid g) return g;
        if (Guid.TryParse(val.ToString(), out var parsed)) return parsed;
        return null;
    }

    private async Task Approve()
    {
        await ProcessDecision(approved: true);
    }

    private async Task Reject()
    {
        await ProcessDecision(approved: false);
    }

    private async Task ProcessDecision(bool approved)
    {
        if (aluno == null) return;
        var id = GetEntityId();
        if (id == null)
        {
            statusMessage = "Não foi possível localizar o identificador do aluno.";
            return;
        }

        var action = approved ? "Approve" : "Reject";

        // confirm with user
        var confirm = await JS.InvokeAsync<bool>("confirm", (approved ? "Confirma aprovar este cadastro?" : "Confirma rejeitar este cadastro?"));
        if (!confirm) return;

        isProcessing = true;
        statusMessage = null;
        try
        {
            var url = $"https://localhost:7297/Aluno/{action}?id={id}";
            var payload = new { Id = id, Notes = validatorNotes };
            var content = new StringContent(JsonSerializer.Serialize(payload), System.Text.Encoding.UTF8, "application/json");
            var resp = await Http.PostAsync(url, content);
            if (resp.IsSuccessStatusCode)
            {
                statusMessage = approved ? "Cadastro aprovado com sucesso." : "Cadastro rejeitado com sucesso.";
            }
            else
            {
                var conteudo = await resp.Content.ReadAsStringAsync();
                statusMessage = $"Erro ao enviar decisão: {resp.StatusCode} - {conteudo}";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Erro durante a solicitação: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }
    string GetStatusClass(string? status)
    {
        return status?.ToLower() switch
        {
            "ativo" => "bg-success text-white",
            "inativo" => "bg-secondary text-white",
            "pendente" => "bg-warning text-dark",
            _ => "bg-info text-dark",
        };
    }
}
